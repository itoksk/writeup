# 応用編：スプレッドシート連携で営業ログを自動記録
## 添付ファイル保存と同時にログを蓄積する高度な設定

---

## この応用編について

この応用編では、第4回で作成した「添付ファイル自動保存エージェント」を拡張し、**スプレッドシートへの自動ログ記録**を追加する方法を解説します。

> **前提条件**
> - 第4回の「添付ファイル自動保存エージェント」を作成済み
> - Google Sheets の基本操作を理解している
> - Gemini ステップの使い方を理解している

---

## この応用編で実現すること

| 機能 | 説明 |
|------|------|
| 自動ログ記録 | 添付ファイル保存時に、送信者・件名・ファイル情報をスプレッドシートに自動記録 |
| AI分類 | Geminiがファイル種類（提案書/見積書など）と案件ステージを自動判定 |
| 検索性向上 | スプレッドシートで送信者・日付・ファイル種類で検索可能 |

---

## 事前準備

### 1. スプレッドシートの作成

Google Sheets で**「営業資料ログ」**スプレッドシートを作成し、以下のヘッダー行を設定してください。

| 日付 | 送信者名 | 送信者メール | 件名 | ファイル名 | ファイル種類 | 案件ステージ | 緊急度 |
|------|----------|--------------|------|------------|--------------|--------------|--------|

> **重要**
> ヘッダー行（1行目）は必ず設定してください。エージェントはこのヘッダーに従ってデータを追記します。

---

## エージェントの拡張手順

第4回で作成した「添付ファイル自動保存エージェント」を編集し、以下のステップを追加します。

### 拡張後のフロー

```
Gmailスターター（重要顧客 + has:attachment）
    ↓
Driveステップ（保存）← 既存
    ↓
Geminiステップ（分類）【NEW】
    ↓
Sheetsステップ（ログ記録）【NEW】
    ↓
Chat DMステップ（通知）← 既存（内容更新）
```

---

### Step 1: Geminiステップを追加（ファイル分類）

Driveステップの後に、Geminiステップを追加してファイルを分類します。

**プロンプト：**

```
以下のメール情報から、添付ファイルの種類と案件ステージを判定してください。

【件名】{email_subject}
【送信者】{sender_name}
【ファイル名】{attachment_name}

以下の形式で出力してください：

file_type: [提案書/見積書/契約書/発注書/カタログ/事例集/スケジュール/その他]
deal_stage: [問い合わせ/提案中/見積もり/契約交渉/受注/その他]
urgency: [HIGH/MEDIUM/LOW]

判定基準：
- 契約書、発注書 → 緊急度HIGH、契約交渉
- 見積書 → 緊急度HIGH、見積もり
- 提案書 → 緊急度MEDIUM、提案中
- カタログ、事例集 → 緊急度LOW、問い合わせ
```

出力は `file_classification` に保存します。

---

### Step 2: 抽出ステップを追加（Gemini出力のパース）

Geminiの出力から各フィールドを抽出します。

| 抽出フィールド | パターン |
|---------------|---------|
| file_type | `file_type: (.+)` |
| deal_stage | `deal_stage: (.+)` |
| urgency | `urgency: (.+)` |

> **注意**
> 抽出ステップはGeminiの出力形式に依存します。出力形式が変わると抽出に失敗する可能性があります。

---

### Step 3: Sheetsステップを追加（ログ記録）

| 項目 | 設定 |
|------|------|
| ステップ | Sheets - Add row |
| スプレッドシート | 「営業資料ログ」を選択 |

**追記するデータ：**

| カラム | 値 |
|--------|-----|
| 日付 | {when_email_was_sent} |
| 送信者名 | {sender_name} |
| 送信者メール | {sender_email} |
| 件名 | {email_subject} |
| ファイル名 | {attachment_name} |
| ファイル種類 | {file_type} |
| 案件ステージ | {deal_stage} |
| 緊急度 | {urgency} |

---

### Step 4: 通知内容の更新

Chat DM通知にログ記録の情報を追加します。

```
📌 添付ファイルを保存しました

【送信者】{sender_name} ({sender_email})
【件名】{email_subject}
【ファイル名】{attachment_name}

📁 保存先: 営業資料フォルダ

📊 AI分類結果:
- ファイル種類: {file_type}
- 案件ステージ: {deal_stage}
- 緊急度: {urgency}

📋 ログをスプレッドシートに記録しました
📧 メールを確認: {email_link}
```

---

## スプレッドシートの活用方法

### フィルター機能

スプレッドシートのフィルター機能を使えば、以下のような検索が可能です：

- **送信者で絞り込み**: 特定の顧客からの資料を一覧
- **ファイル種類で絞り込み**: 見積書だけを表示
- **緊急度で絞り込み**: HIGHの案件を優先確認
- **日付で絞り込み**: 今週受信した資料を表示

### ピボットテーブル

ピボットテーブルを作成すれば、以下のような分析が可能です：

- 顧客別のファイル受信数
- 月別の資料種類の推移
- 案件ステージ別の分布

---

## トラブルシューティング

| 問題 | 原因 | 対処 |
|------|------|------|
| ログが記録されない | スプレッドシートの権限 | エージェントにスプレッドシートへのアクセス権を付与 |
| 分類が正しくない | Geminiの判定ミス | プロンプトに具体例を追加 |
| 抽出が失敗する | Geminiの出力形式が変わった | 抽出パターンを調整 |

---

## 注意事項

- この応用編の設定は複雑なため、基本の第4回講座を完了してから取り組んでください
- Geminiの出力は毎回完全に同じ形式にならない場合があります
- 抽出ステップがうまく動作しない場合は、Geminiプロンプトの出力形式指定をより厳密にしてください

---

## 関連リソース

- [第4回：営業資料を自動で蓄積＆可視化](lesson4.html) - 基本編
- [営業資料ログサンプル（CSV）](営業資料ログ_サンプル.csv) - スプレッドシートのサンプルデータ
