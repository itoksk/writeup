# 第3回：追客漏れゼロの受信トレイ！
## 要対応案件メールの自動ラベル化＆次アクション設計

---

## この回の目標

第2回ではスケジュール実行（バッチ処理）でしたが、今回は**メール受信時にリアルタイムで起動**するエージェントを作成します。重要な案件メールを即座に検知し、「要対応」ラベルを自動付与することで、追客漏れをゼロにします。

---

## Before / After

### BEFORE：受講前
- 要対応メールが受信トレイに埋もれる
- 追客タイミングを逃して失注
- 月1〜2件の追客漏れが発生
- 次アクションを手動で管理

### AFTER：受講後
- 要対応メールに自動でラベル付与
- 受信時にリアルタイムで通知
- 追客漏れゼロを実現
- 次アクションをAIが提案

---

## 作成するエージェント

| 項目 | 内容 |
|------|------|
| 名前 | 追客漏れゼロエージェント |
| スターター | Gmail - Email received（メール受信時） |
| ステップ | Geminiステップで判定 → 条件分岐 → Gmailステップでラベル付与 → Chat DMステップで通知 |
| 効果 | 追客漏れ 月1-2件 → ゼロに |

> **0件** 追客漏れを完全ゼロに（月1-2件の失注を防止）

---

## スケジュールスターター vs Gmailスターター

| スターター | 特徴 | 適した用途 |
|-----------|------|-----------|
| 第2回（スケジュールスターター） | 毎朝まとめて処理 | 全体把握に適している |
| 第3回（Gmailスターター） | メール受信時に即座に処理 | 緊急案件の見落とし防止に適している |

---

## エージェントのフロー

このエージェントは「条件分岐」を使います。Geminiが「要対応：YES」と判定した場合のみ、ラベル付与とChat通知を実行します。

```
Gmailスターター
    ↓
Geminiステップ
    ↓
条件分岐ステップ
    ↓
[YES] → Gmailラベル付与 → Chat DMステップ
[NO]  → 終了（アクションなし）
```

---

## 作成手順

### Step 01: Gmailスターター設定
「Starter」で「Gmail - Email received」を選択。重要顧客からのメール受信時に起動するよう、fromフィルターを設定します。

```
# フィルター例（メールアドレス指定）
from:yamada@a-corp.co.jp OR from:tanaka@b-inc.com
```

> **注意**: `from:`演算子ではドメイン指定（@xxx.co.jp）は使用できません。メールアドレスを個別に指定してください。

### Step 02: Geminiステップ（分析）
メール内容をGeminiステップで分析。要対応判定、緊急度、次アクションを出力させます。

### Step 03: 条件分岐ステップ
Geminiの出力に「YES」が含まれる場合のみ次のステップへ進む条件を設定します。

### Step 04: Gmailステップ（ラベル付与）
「Gmail - Add label」で「要対応」ラベルを自動付与。事前にGmailでラベルを作成しておきます。

### Step 05: Chat DMステップ（通知）
Geminiの分析結果と次アクションをChat DMで通知。元のメールへのリンクも含めます。
> ⚠️ **スペースへの投稿は削除されました**

---

## 事前準備

> ⚠️ **事前準備：Gmailラベルの作成**
> Gmailで「要対応」ラベルを事前に作成してください。Studioからは既存のラベルのみ選択できます。

---

## Geminiプロンプト

要対応判定は「YES」または「NO」で明確に出力させます。条件分岐で使うため、判定結果が曖昧にならないようにプロンプトを設計します。

### 推奨プロンプト

```
以下の営業メールを分析し、対応が必要かどうか判定してください。

送信者: {sender}
件名: {subject}
本文:
{email_body}

以下の形式で出力してください：

【要対応判定】YES または NO
【理由】判定の理由（1文）
【緊急度】HIGH/MEDIUM/LOW
【案件ステージ】問い合わせ/提案中/見積もり/契約交渉
【次アクション】具体的に取るべきアクション
【対応期限】推奨対応期限（例：本日中、3日以内、1週間以内）
【返信ドラフト】簡潔な返信案（50文字程度）

判定基準：
- YES: 返信や対応が必要なメール（質問、依頼、確認要請など）
- NO: 情報共有のみ、CCで受信、自動送信メールなど
```

### プロンプトのポイント
- **判定結果を最初に**：条件分岐で使いやすいよう、「YES/NO」を最初に出力
- **判定基準を明示**：Geminiが迷わないよう、YES/NOの基準を記載
- **返信ドラフト**：すぐにアクションを起こせるよう、返信案も出力
- **対応期限**：優先順位付けに活用

### 出力例（要対応の場合）

```
【要対応判定】YES
【理由】見積もり修正の依頼があり、返信が必要です。
【緊急度】HIGH
【案件ステージ】見積もり
【次アクション】見積書を修正して再送付する
【対応期限】本日中
【返信ドラフト】ご連絡ありがとうございます。見積もりを修正の上、本日中にお送りいたします。
```

---

## 条件分岐の設定

Geminiの出力に「YES」が含まれる場合のみ、ラベル付与とChat通知を実行します。「Conditional」ステップを追加して設定します。

### 条件式

```
{gemini_output} contains "YES"
```

### 分岐の動作
- **True（YES）**：Gmailステップでラベル「要対応」を付与 → Chat DMステップで通知を送信
- **False（NO）**：終了（アクションなし）

### 条件分岐ステップの設定方法
- **条件タイプ**：「Text contains」を選択
- **変数**：Geminiステップの出力を選択
- **検索文字列**：「YES」（大文字で完全一致）

> ⚠️ **よくある問題**
> Geminiの出力が「Yes」「yes」など大文字小文字が異なる場合、条件が一致しないことがあります。プロンプトで「YESまたはNO（大文字）」と明示するか、条件式で大文字小文字を無視する設定を使用してください。

---

## Chat DM通知テンプレート

```
📌 要対応案件メール

【送信者】{sender_name} ({sender_email})
【件名】{email_subject}

{gemini_output}

---
📧 元のメールを確認: {email_link}
ラベル「要対応」を自動付与しました。
```

### 通知テンプレートのポイント
- **送信者情報**：誰からのメールか即座にわかる
- **Gemini分析結果**：次アクションと期限を含む
- **メールリンク**：クリックで元のメールを開ける
- **ラベル付与通知**：Gmailを確認する際の目印

---

## Before / After 比較表

| 項目 | Before | After |
|------|--------|-------|
| 対応すべきメールの把握 | 手動で1件ずつ確認 | 自動でラベル付与 |
| 次アクションの判断 | 自分で考える | Geminiが提案 |
| 追客漏れ | 月1-2件発生 | ゼロ |
| 緊急案件の把握 | メールを開くまで不明 | 即座にChat通知 |
| 返信の着手 | 内容を読んでから考える | ドラフトがあるので即対応可能 |

---

## 運用のコツ

### 通知の頻度調整
メール受信のたびに通知が来ると多すぎる場合があります。「緊急度がHIGHの場合のみ通知」などの追加条件を設けることで、本当に重要な案件だけに絞れます。

### ラベルの活用
「要対応」ラベルが付いたメールをGmailでフィルター表示すると、対応すべきメールを一覧で確認できます。朝の確認と併用すると効果的です。

### 第2回エージェントとの連携
第2回の「毎朝要約」と今回の「リアルタイム通知」は補完関係にあります。両方を有効化することで、漏れのない営業メール管理が実現できます。

---

## 次回予告

### 第4回：提案資料と見積書を完全自動整理！
**Drive保存 × 定期送信フローで営業資料を整流化**

次回は添付ファイルの自動整理に取り組みます。提案資料・見積書をDriveの案件フォルダに自動保存し、
週次で資料一覧レポートを自動送信するエージェントを作成します。
