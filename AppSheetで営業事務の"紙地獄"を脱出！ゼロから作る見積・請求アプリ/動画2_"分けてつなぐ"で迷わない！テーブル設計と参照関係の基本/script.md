# 動画2: 顧客・社員・サービス・注文・注文詳細テーブルを設計する

## 想定時間: 10分

## 学習目標
- 5つのテーブルの役割と関係性を理解する
- 参照型（Ref）を使ったテーブル間の接続方法を学ぶ
- 親子関係（注文と注文詳細）の設定方法を習得する
- 自動生成される仮想カラムの活用方法を理解する

---

## オープニング（1分）

前回は、AppSheetの概要と全体像を確認しました。今回は、5つのテーブル（顧客・社員・サービス・注文・注文詳細）を実際に設計していきます。

「分けてつなぐ」というデータ設計の基本を学び、参照型（Ref）を使ってテーブル間を接続する方法を実践します。

---

## 5つのテーブルの役割（2分）

### 1. 顧客テーブル
- **役割**: 取引先の基本情報を管理
- **カラム**: ID顧客、顧客名、カテゴリ、住所、電話、メール

### 2. 社員テーブル
- **役割**: 社内の担当者情報を管理
- **カラム**: ID社員、社員名、役職、電話、メール

### 3. サービステーブル
- **役割**: 提供するサービスのマスタ情報
- **カラム**: IDサービス、サービス名、価格、詳細

### 4. 注文テーブル（親テーブル）
- **役割**: 注文のヘッダー情報を管理
- **カラム**: ID注文、ID社員（Ref）、ID顧客（Ref）、ステータス、発行日、納期、見積番号、請求番号、合計金額など

### 5. 注文詳細テーブル（子テーブル）
- **役割**: 注文の明細情報を管理
- **カラム**: ID注文詳細、ID注文（Ref）、IDサービス（Ref）、数量、単価、納入金額

**ポイント**: 注文テーブルと注文詳細テーブルは「1対多」の親子関係になります。

---

## 参照型（Ref）の設定方法（3分）

### Refとは？
参照型（Ref）は、別のテーブルのレコードを参照するための型です。外部キーのような役割を果たします。

### 設定手順
1. **AppSheet Editorの「Data」タブを開く**
2. **注文テーブルを選択**
3. **「ID社員」カラムをクリック**
4. **Type を「Ref」に変更**
5. **Source table を「社員」に設定**

これで、注文入力時に社員テーブルから社員を選択できるようになります。

同様に、「ID顧客」も「Ref」→「顧客」に設定します。

---

## 親子関係の設定（2分）

### 注文テーブルと注文詳細テーブル
1. **注文詳細テーブルの「ID注文」をRefに設定**
2. **Source table を「注文」に指定**
3. **Is a part of? を「Yes」に設定**

これにより、注文レコードを削除すると、関連する注文詳細レコードも自動的に削除されます。

### 仮想カラムの自動生成
親子関係を設定すると、AppSheetが自動的に仮想カラムを生成します：

- **注文テーブルに「Related 注文詳細s」カラムが追加される**
  - この注文に紐づく全ての注文詳細レコードを参照できる
  - `SUM([Related 注文詳細s][納入金額])` で合計金額を計算可能

---

## 重要な数式（2分）

### 見積番号の自動生成
```
CONCATENATE("MT", TEXT([発行日], "YYYYMMDD"), "-", RIGHT("0" & (COUNT(SELECT(注文[_ROWNUMBER], [発行日] = [_THISROW].[発行日])) + 1), 2))
```
- 例: MT20251013-01

### 請求番号の自動生成
```
SUBSTITUTE([見積番号], "MT", "SK")
```
- 例: SK20251013-01

### 納入単価合計
```
SUM([Related 注文詳細s][納入金額])
```

### 消費税
```
[納入単価合計] * 0.1
```

### 合計金額
```
[納入単価合計] + [消費税]
```

---

## まとめと次回予告（1分）

本日は、5つのテーブルの設計と、参照型（Ref）を使った接続方法を学びました。

次回（動画3）は、「フォームと一覧画面を整える」というテーマで、使いやすいUIの作り方を実践します。

それでは、次回の動画でお会いしましょう！
