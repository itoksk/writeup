# 第4回：Driveとスプレッドシートを連携する！進捗ダッシュボードが自動で更新される仕組み

## 学習目標

チームの日報・週報提出状況をリアルタイムで可視化するダッシュボードを構築。未提出者の自動検知、提出率の集計、週次サマリーの生成を自動化し、管理者がゼロタッチで進捗を把握できる仕組みを作ります。

---

## BEFORE / AFTER

| Before（受講前） | After（受講後） |
|---|---|
| 提出状況を毎日手動で確認 | ダッシュボードで即時確認 |
| 未提出者の検知が翌朝になる | 未提出者は当日20:00に自動アラート |
| 週次レポート作成に1時間 | 週次レポートは自動生成 |
| 添付ファイルが散逸して検索困難 | 4つのAgentでデータ連携を実現 |

---

## Drive連携について

タイトルにあるDrive連携は、主にエージェント4「添付ファイル保存＆内容確認」で実現します。このエージェントでは：

- 添付ファイルをGoogleドライブに自動保存
- 保存後の{Drive links}変数をGeminiに渡して内容を読み取り
- 「開いて」キーワードでファイルの中身を分析

推奨デモの「未提出チェック」はDriveを使いませんが、エージェント4を試すとDrive連携の威力がわかります。

---

## 作成するエージェント一覧

| No. | エージェント名 | 説明 |
|---|---|---|
| 1 | Submission Check Agent | 毎日20:00に未提出者を検知してアラート送信。遅延提出者のリストも作成 |
| 2 | Dashboard Update Agent | 毎日21:00にダッシュボードを自動更新。本日の提出数・提出率を集計 |
| 3 | Weekly Summary Agent | 金曜18:00に週次サマリーを生成。提出率ランキングと改善提案を出力 |
| 4 | Drive Sync Agent | 添付ファイルをDriveに自動保存。日付・送信者で整理して管理 |

**デモ推奨:** 4つのエージェントのうち「未提出チェック」がデモに最適です。理由：
1. **Scheduledスターター** - Lesson 1-3はGmail受信トリガーでしたが、時間トリガーは新しい学び
2. **Sheetsからデータ読み込み** - これまでは書き込みのみでしたが、読み込んで処理するのは新しい
3. **シンプルで再現しやすい** - 2つのシートを用意すればすぐテスト可能

---

## エージェント作成プロンプト

以下のプロンプトをコピーして、Google Workspace Studio（https://studio.workspace.google.com/）で実行してください。

### エージェント1: 未提出チェック（デモ推奨）

```
日報の未提出チェックエージェントを作成してください。
すべての出力は日本語でお願いします。

【エージェント名】
日報未提出チェック

【説明】
毎日20時にスプレッドシートをチェックし、日報未提出者を検知して自分にChat DMで通知します

【スターター】
スケジュール - 毎日20:00

【処理フロー】
1. スプレッドシート読み込み（メンバーマスタ）:
   - 対象シート: 日報管理シート > メンバーマスタ
   - 操作: すべての行を取得
   - 取得する列: 名前, メールアドレス, 部署

2. スプレッドシート読み込み（提出ログ）:
   - 対象シート: 日報管理シート > 提出ログ
   - 操作: すべての行を取得
   - 取得する列: 日付, 名前, 提出時刻

3. Geminiに聞く（未提出者の特定）:
   あなたは日報の提出状況をチェックするアシスタントです。
   メンバーマスタに登録されている全員が日報を提出する必要があります。

   【メンバーマスタ（日報提出が必要な全メンバー）】
   名前: {名前}
   部署: {部署}
   ※このリストに載っている人全員が本日の日報を提出する必要があります

   【提出ログ】
   名前: {名前}
   提出時刻: {提出時刻}
   日付: {日付}

   【やること】
   1. まず本日の日付を確認してください
   2. 提出ログから、本日の日付のデータだけを抽出してください
   3. メンバーマスタの「名前」と、本日の提出ログの「名前」を比較してください
   4. メンバーマスタにいるが、本日の提出ログにいない人が「未提出者」です
   5. 本日の提出ログで「提出時刻」が17:00より後の人は「遅延提出者」です

   【出力形式例】（必ず日本語で出力してください）
   ■ 未提出者（○名）
   ・氏名（部署）
   ※未提出者がいない場合は「なし」と記載

   ■ 遅延提出者（○名）
   ・氏名（部署）- （提出時刻）提出
   ※遅延提出者がいない場合は「なし」と記載

   ■ 提出状況サマリー
   ・全メンバー数: ○名
   ・提出済み: ○名
   ・未提出: ○名
   ・提出率: ○○%

   ■ 判定結果
   「未提出者あり」または「全員提出済み」

4. 条件分岐:
   - 判定結果が「未提出者あり」の場合 → Chat DM通知へ
   - 判定結果が「全員提出済み」の場合 → 終了

5. Chat DM送信（自分宛て）:
   【日報未提出アラート】

   本日の日報提出状況をお知らせします。

   {Geminiの出力結果}

   未提出者へのフォローをお願いします。

【出力先】
- 自分へのChat DM

【事前準備が必要なもの】
1. 「日報管理シート」という名前のスプレッドシートを作成
2. その中に「メンバーマスタ」シートを作成
   - A列: 名前
   - B列: メールアドレス
   - C列: 部署
3. その中に「提出ログ」シートを作成
   - A列: 日付（例: 2024/01/15）
   - B列: 名前
   - C列: 提出時刻（例: 17:30）
   - D列: ステータス（提出済）
4. テスト用にメンバーマスタに5名登録し、提出ログには3名分だけ登録する（2名が未提出になる）

このエージェントを日本語で作成してください。
```

---

### エージェント2: ダッシュボード更新

```
日報ダッシュボード更新エージェントを作成してください。
すべての出力は日本語でお願いします。

【エージェント名】
日報ダッシュボード更新

【説明】
毎日21時に本日の提出データを集計し、ダッシュボードシートを自動更新します

【スターター】
スケジュール - 毎日21:00

【処理フロー】
1. スプレッドシート読み込み（提出ログ）:
   - 対象シート: 日報管理シート > 提出ログ
   - 操作: すべての行を取得
   - 取得する列: 日付, 名前, 提出時刻

2. スプレッドシート読み込み（メンバーマスタ）:
   - 対象シート: 日報管理シート > メンバーマスタ
   - 操作: すべての行を取得
   - 取得する列: 名前, 部署

3. Geminiに聞く（集計）:
   本日の日報提出データを集計してください。

   【メンバーマスタ（日報提出が必要な全メンバー）】
   名前: {名前}
   部署: {部署}

   【提出ログ】
   名前: {名前}
   提出時刻: {提出時刻}
   日付: {日付}

   【やること】
   1. まず本日の日付を確認してください
   2. 提出ログから、本日の日付のデータだけを抽出してください
   3. メンバーマスタの人数と、本日の提出者数を比較してください
   4. 提出率を計算してください（本日の提出者数 ÷ メンバーマスタの人数 × 100）

   【出力形式例】（日本語で出力）
   本日の日付: （本日の日付）
   提出数: ○名
   全メンバー数: ○名
   未提出者数: ○名
   提出率: ○○%

4. 抽出:
   - 提出数
   - 提出率
   - 未提出者数

5. スプレッドシート書き込み（ダッシュボード更新）:
   - 対象シート: 日報管理シート > ダッシュボード
   - 操作: 行を追加
   - 追加データ: 日付, 提出数, 提出率, 未提出者数

【出力先】
- スプレッドシート（ダッシュボードシート）

このエージェントを日本語で作成してください。
```

---

### エージェント3: 週次サマリー

```
日報の週次サマリーエージェントを作成してください。
すべての出力は日本語でお願いします。

【エージェント名】
日報週次サマリー

【説明】
毎週金曜18時に今週の提出データを分析し、週次レポートを自分にChat DMで通知します

【スターター】
スケジュール - 毎週金曜日 18:00

【処理フロー】
1. スプレッドシート読み込み（提出ログ）:
   - 対象シート: 日報管理シート > 提出ログ
   - 操作: すべての行を取得
   - 取得する列: 日付, 名前, 提出時刻

2. スプレッドシート読み込み（メンバーマスタ）:
   - 対象シート: 日報管理シート > メンバーマスタ
   - 操作: すべての行を取得
   - 取得する列: 名前, 部署

3. Geminiに聞く（週次分析）:
   今週の日報提出データを分析し、週次レポートを作成してください。

   【メンバーマスタ（日報提出が必要な全メンバー）】
   名前: {名前}
   部署: {部署}

   【提出ログ】
   名前: {名前}
   提出時刻: {提出時刻}
   日付: {日付}

   【やること】
   1. まず本日の日付を確認し、今週の月曜日〜金曜日の日付範囲を特定してください
   2. 提出ログから、今週（月曜〜金曜）の日付のデータだけを抽出してください
   3. メンバーごとに、今週何日提出したかをカウントしてください
   4. 各メンバーの提出率を計算してください（提出日数 ÷ 5日 × 100）
   5. 全員が毎日提出した場合の総数と、実際の提出数を比較してください

   【出力形式例】（日本語で出力）
   ■ 対象期間
   （今週の月曜日）〜（今週の金曜日）

   ■ 今週のサマリー
   ・総提出数: ○件
   ・期待提出数: ○件（メンバー数 × 5日）
   ・平均提出率: ○○%
   ・皆勤賞: （5日すべて提出した人の氏名）

   ■ メンバー別提出率ランキング
   1位: 氏名 - ○○%（○/5日）
   2位: 氏名 - ○○%（○/5日）
   ...（全メンバー分を記載）

   ■ 要フォロー（提出率80%未満）
   ・氏名 - ○○%（○/5日）
   ※該当者がいない場合は「なし」と記載

   ■ 改善提案
   ・（チーム全体の傾向と改善点を記載）

4. Chat DM送信（自分宛て）:
   【週次日報サマリー】

   今週の日報提出状況をお知らせします。

   {Geminiの出力結果}

【出力先】
- 自分へのChat DM

このエージェントを日本語で作成してください。
```

---

### エージェント4: 添付ファイル保存＆内容確認（参考）

```
添付ファイル保存＆内容確認エージェントを作成してください。
すべての出力は日本語でお願いします。

【エージェント名】
添付ファイル保存＆内容確認

【説明】
メールに添付されたファイルをGoogleドライブに自動保存し、Geminiでファイル内容を読み取って要約します

【スターター】
Gmail - 新しいメールを受信したとき
条件: 添付ファイルがあるメール

【処理フロー】
1. 条件分岐:
   - 添付ファイルがある場合 → 次のステップへ
   - 添付ファイルがない場合 → 終了

2. Googleドライブに保存:
   - 保存先フォルダ: 日報週報フォルダ/{年}/{月}/
   - ファイル名: {日付}_{送信者名}_{元のファイル名}
   - ※このステップで{Drive links}変数が生成されます

3. Geminiに聞く（ファイル内容の読み取り）:
   以下のファイルを開いて、内容を日本語で要約してください。

   ファイル: {Drive links}

   【出力形式】（日本語で出力）
   ■ ファイル種類
   報告書 / 資料 / その他

   ■ 内容の要約（3行以内）
   ・...
   ・...
   ・...

   ■ 重要なポイント
   ・...

   ■ 対応が必要な事項
   ・あれば記載、なければ「特になし」

   ※「開いて」というキーワードと{Drive links}変数を組み合わせることで、
   Geminiがファイルの中身を読み取って分析できます。

4. スプレッドシート書き込み（記録）:
   - 対象シート: 日報管理シート > 提出ログ
   - 操作: 行を追加
   - 追加データ: 日付, 送信者, Driveリンク, ファイル要約

5. Chat DM送信（自分宛て）:
   【添付ファイル保存完了】

   以下のファイルをGoogleドライブに保存しました。

   ■ 送信者: {送信者}
   ■ 保存先: {Driveリンク}

   ■ ファイル内容の要約
   {Geminiの出力結果}

【出力先】
- Googleドライブ（ファイル保存）
- スプレッドシート（リンク・要約記録）
- 自分へのChat DM

【重要なTips】
添付ファイルの内容をGeminiに読み取らせるには:
1. まずGoogleドライブに保存して{Drive links}変数を取得
2. Geminiに聞くステップで「開いて」キーワードと{Drive links}を使用
3. これによりGeminiがファイルを開いて内容を分析できます

このエージェントを日本語で作成してください。
```

---

## システム全体の流れ

| 時刻 | 処理内容 |
|---|---|
| 17:00 | 提出依頼: Daily Report Request Agentが日報提出依頼を送信（Lesson 1で作成済み） |
| 17:00〜19:00 | 日報受信・処理: Report Summary Agent / Quality Check Agentが受信した日報を処理（Lesson 2-3で作成済み） |
| 20:00 | 未提出チェック: Submission Check Agentが未提出者を検知し、管理者にアラート送信 |
| 21:00 | ダッシュボード更新: Dashboard Update Agentが本日のデータを集計し、ダッシュボードを更新 |
| 金曜 18:00 | 週次サマリー: Weekly Summary Agentが週次の提出率とトレンドを分析してレポート生成 |

---

## テスト用サンプルデータ

「未提出チェック」エージェントをテストするために、以下のデータをスプレッドシートに登録してください。

### メンバーマスタシート

| 名前 | メールアドレス | 部署 |
|---|---|---|
| 山田太郎 | yamada@example.com | 営業部 |
| 佐藤花子 | sato@example.com | 営業部 |
| 鈴木一郎 | suzuki@example.com | 開発部 |
| 田中美咲 | tanaka@example.com | 開発部 |
| 高橋健二 | takahashi@example.com | 総務部 |

### 提出ログシート（テスト用：本日分）

| 日付 | 名前 | 提出時刻 | ステータス |
|---|---|---|---|
| 2024-01-15 | 山田太郎 | 17:30 | 提出済 |
| 2024-01-15 | 佐藤花子 | 18:15 | 提出済 |
| 2024-01-15 | 鈴木一郎 | 17:45 | 提出済 |

**期待される結果:** メンバー5名のうち3名が提出済み。未提出者は「田中美咲（開発部）」「高橋健二（総務部）」の2名。提出率は60%。

**テストのコツ:** Scheduledスターターは指定時刻にならないと動作しません。テスト時は「テスト実行」ボタンを使うか、スターターを一時的に「手動実行」に変更してください。

---

## エージェント設計

### Agent 1: Submission Check Agent

| 項目 | 設定値 |
|---|---|
| エージェント名 | 未提出チェック |
| 説明 | 未提出者を検知し、管理職に通知 |
| スターター | Scheduled（毎日20:00） |
| データソース | Sheets（提出ログシート、メンバーマスタシート） |
| 処理ステップ | Geminiでメンバーリストと本日の提出を比較 |
| 出力 | Chat DM通知（未提出者がいる場合） |

### Agent 2: Dashboard Update Agent

| 項目 | 設定値 |
|---|---|
| エージェント名 | ダッシュボード更新 |
| 説明 | 日次の提出統計でダッシュボードを更新 |
| スターター | Scheduled（毎日21:00） |
| データソース | Sheets（提出ログシート） |
| 処理ステップ | 本日のデータを集計、統計を算出 |
| 出力 | Sheets更新（ダッシュボードシート） |

### Agent 3: Weekly Summary Agent

| 項目 | 設定値 |
|---|---|
| エージェント名 | 週次サマリー |
| 説明 | 週次の提出サマリーとランキングを生成 |
| スターター | Scheduled（金曜18:00） |
| データソース | Sheets（今週の提出ログ） |
| 処理ステップ | Geminiで週次データを分析、傾向を検出 |
| 出力 | Chat DM通知（週次レポート） |

---

## 提出ログシート構成

| 列 | 列名 | データ型 | 例 |
|---|---|---|---|
| A | 日付 | Date | 2024/01/15 |
| B | 提出者 | Text | 山田太郎 |
| C | メールアドレス | Email | yamada@company.com |
| D | 種類 | Text | 日報 / 週報 |
| E | 提出時刻 | Time | 17:30 |
| F | ステータス | Text | 提出済 / 遅延 |
| G | 品質判定 | Text | 承認済 / 要修正 / 再提出 |
| H | Driveリンク | URL | （添付がある場合） |

**ポイント:** このシートはLesson 2-3で作成したReport Summary Agent / Quality Check Agentが自動で記録します。

---

## 未提出検知プロンプト

```
日報の提出状況をチェックしてください。

【本日の日付】
{current_date}

【提出期限】
17:00

【メンバー一覧】（日報提出が必要なメンバー）
{member_list}

【本日の提出ログ】
{today_submissions}

以下を特定してください:
1. 本日の日報を提出していないメンバー
2. 遅延提出したメンバー（17:00以降に提出）

【出力形式】（日本語で出力）
---
■ 未提出者
・山田太郎（yamada@example.com）
・佐藤花子（sato@example.com）

■ 遅延提出者
・鈴木一郎 - 18:30に提出

■ 本日の提出状況
・対象者数: ○名
・定時提出: ○名
・遅延提出: ○名
・未提出: ○名
・提出率: ○○%
---
```

---

## 未提出アラートテンプレート

```
**日報未提出アラート** ({date})

以下のメンバーが本日の日報を提出していません。

■ 未提出者 ({missing_count}名)
{missing_members_list}

■ 遅延提出 ({late_count}名)
{late_members_list}

■ 本日の提出状況
・提出済: {submitted_count}名
・未提出: {missing_count}名
・提出率: {submission_rate}%

フォローをお願いします。
```

---

## 週次サマリー生成プロンプト

```
今週の日報提出状況をまとめた週次サマリーを作成してください。

【対象期間】
{week_start} 〜 {week_end}

【今週の提出ログ】
{weekly_submission_log}

【メンバー一覧】
{member_list}

以下の項目を含めてサマリーを作成してください:

【出力形式】（日本語で出力）
---
■ 今週のサマリー
・総提出数: ○件
・平均提出率: ○○%

■ 提出率ランキング（上位3名）
1位: 山田太郎 - 100%（5/5日）
2位: 佐藤花子 - 80%（4/5日）
3位: 鈴木一郎 - 60%（3/5日）

■ 皆勤賞
・毎日提出した人の名前

■ 要フォロー（提出率80%未満）
・田中美咲 - 40%（2/5日）
・高橋健二 - 20%（1/5日）

■ チーム全体の傾向
・（傾向の分析を記載）

■ 改善提案
・（改善案があれば記載）
---

Chatメッセージ用に簡潔にまとめてください。
```

---

## Driveフォルダ構成

```
日報週報/
├── 2024/
│   ├── 01/
│   │   ├── 20240115_山田太郎_報告書.pdf
│   │   ├── 20240115_佐藤花子_添付資料.xlsx
│   │   └── 20240119_鈴木一郎_週報.pdf
│   ├── 02/
│   └── 03/
└── 2025/
    └── 01/
```

**ポイント:** 添付ファイルはDriveに自動保存され、提出ログシートにリンクが記録されます。後から検索・参照が容易になります。

---

## Tips: Geminiで添付ファイルの内容を読み取る方法

Gmailスターターで受信した添付ファイルの中身をGeminiに分析させたい場合:

1. **Step 1:** まずDriveステップでファイルを保存 → `{Drive links}` 変数が生成される
2. **Step 2:** Geminiステップで「**開いて**」キーワードと共に {Drive links} 変数を使用
3. **例:** 「以下のファイルを**開いて**、内容を要約してください。ファイル: {Drive links}」

※ 添付ファイルを直接Geminiに渡すことはできません。必ずDriveに保存してからDrive links経由で読み取ります。

---

## 効果測定の指標

| 指標 | Before | After | 改善率 |
|---|---|---|---|
| 進捗確認時間 | 30分/日 | 2分/日 | 93%削減 |
| 未提出者検知時間 | 翌朝 | 当日20:00 | 即日化 |
| 週次レポート作成 | 60分 | 自動 | 100%削減 |
| ファイル検索時間 | 10分/件 | 30秒/件 | 95%削減 |

---

## 作成ステップ

1. **Sheetsの準備**: 提出ログシート、メンバーマスタシート、ダッシュボードシートを同一スプレッドシートに作成。列構成は上記の通り設定

2. **Submission Check Agent 作成**: Google Workspace Studio → Create Agent → Schedule: Daily 20:00 → Data Source: Sheets → Process: Gemini未提出検知 → Output: Chat DM

3. **Dashboard Update Agent 作成**: Create Agent → Schedule: Daily 21:00 → Data Source: 提出ログシート → Process: 集計 → Output: ダッシュボードシート更新

4. **Weekly Summary Agent 作成**: Create Agent → Schedule: Friday 18:00 → Data Source: 今週の提出ログ → Process: Gemini分析 → Output: Chat DM週次レポート（自分宛）

5. **Drive Sync設定**: 既存のReport Summary Agent / Quality Check Agentに添付ファイル保存アクションを追加。Driveフォルダ構成を設定

6. **テスト・調整**: 各エージェントをRun Testで動作確認。データの流れ、集計の正確性、通知の内容を確認して調整

---

## テスト確認ポイント

- [ ] 未提出者が正しく検知されているか（メンバーマスタとの照合）
- [ ] 遅延提出（17:00以降）が正しく判定されているか
- [ ] ダッシュボードの集計値が正確か（提出数、提出率、未提出者数）
- [ ] Chat DMアラートが自分に送信されているか
- [ ] 週次サマリーのランキング・提出率が正確か
- [ ] 添付ファイルがDriveの正しいフォルダに保存されているか

---

## 今日のポイント

- 提出ログ・メンバーマスタ・ダッシュボードの3シートでデータを一元管理
- Submission Check Agentが毎日20:00に未提出者を自動検知・アラート
- Dashboard Update Agentが毎日21:00にダッシュボードを自動更新
- Weekly Summary Agentが金曜18:00に週次サマリーと改善提案を自動生成
- 添付ファイルはDriveに自動整理され、後から検索・参照が容易に
- 管理者はダッシュボードを見るだけでチーム状況を即座に把握可能

---

## 注意事項

Workspace Studioでは外部へのメール送信は未対応です。週次レポートは自分宛のChat DMで通知します。
