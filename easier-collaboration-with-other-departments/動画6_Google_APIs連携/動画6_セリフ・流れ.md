# 動画6: Google APIs統合連携！Gmail・Calendar・Chat・Driveを一元的に自動操作する方法

**撮影時間**: 10分  
**目標**: Google Apps Scriptによる複数Google APIの統合連携自動化をマスター

---

## 🎬 オープニング（0:00-1:00）

### **セリフ**
「これまで個別の機能を作ってきましたが、今回は『統合』です！Gmail、Calendar、Chat、Drive...複数のGoogle APIを連携させて、真の自動化システムを完成させます。」

「外部サービス連携は一切不要。Google Apps Script内で複数のGoogle APIを直接連携させて、シンプルで強力な統合システムを構築します！」

**【画面】**: 複数のGoogle APIが連携して動作する様子

---

## 🎯 統合連携の価値（1:00-2:00）

### **セリフ**
「なぜ統合連携が重要なのでしょうか？」

**【画面】**: Before/After比較
- Before: 個別処理（メール送信、カレンダー登録、通知送信を手動実行）
- After: 一つのトリガーで全て自動実行

「ユーザーの一つのアクションで、関係する全ての人・システムに適切な情報が自動配信。これが真の自動化です。」

---

## 🏗️ 統合アーキテクチャ（2:00-3:00）

### **セリフ**
「今回の統合システムの全体構成をご説明します」

**【画面】**: アーキテクチャ図
```
フォーム送信（トリガー）
    ↓
Google Apps Script（中央ハブ）
    ├→ Gmail API（メール配信）
    ├→ Calendar API（予定登録）
    ├→ Chat API（チーム通知）
    ├→ Drive API（ファイル準備）
    └→ 結果ログ（実行記録）
```

「一つのトリガーから、並行して複数のアクションを実行。しかも全てGoogle環境内で安全に処理されます。」

---

## 🛠️ 実装デモ Part1: Gmail API統合（3:00-4:30）

### **セリフ**
「まず、Gmail APIによる高度なメール送信機能を実装します」

#### **Step 1**: Gmail API有効化（3:00-3:15）
**【操作・セリフ】**:
1. Apps Script → サービス → Gmail API追加
2. 「これで Gmail の全機能にアクセス可能になりました」

#### **Step 2**: 添付ファイル付きメール送信（3:15-4:30）
**【コード実演】**:
```javascript
function sendWelcomeEmailWithAttachments(employeeData) {
  console.log('Gmail API実行:', employeeData.email);
  
  try {
    // メール内容生成（前回の AI生成機能を活用）
    const emailContent = generatePersonalizedWelcomeEmail(employeeData);
    
    // 添付ファイル準備
    const attachments = prepareWelcomeAttachments(employeeData);
    
    // Gmail API でメール送信
    const emailPayload = {
      userId: 'me',
      resource: {
        raw: createRawEmailWithAttachments(
          employeeData.email,
          emailContent.subject,
          emailContent.body,
          attachments
        )
      }
    };
    
    const response = Gmail.Users.Messages.send(emailPayload);
    console.log('Gmail API送信成功:', response.id);
    
    return { success: true, messageId: response.id };
    
  } catch (error) {
    console.error('Gmail API エラー:', error);
    return { success: false, error: error.message };
  }
}

function prepareWelcomeAttachments(employeeData) {
  const attachments = [];
  
  try {
    // 会社案内PDF
    const companyGuide = DriveApp.getFileById('COMPANY_GUIDE_FILE_ID');
    attachments.push({
      name: '会社案内.pdf',
      mimeType: 'application/pdf',
      content: Utilities.base64Encode(companyGuide.getBlob().getBytes())
    });
    
    // 部署別資料
    const deptGuideId = getDepartmentGuideFileId(employeeData.department);
    if (deptGuideId) {
      const deptGuide = DriveApp.getFileById(deptGuideId);
      attachments.push({
        name: `${employeeData.department}_案内.pdf`,
        mimeType: 'application/pdf',
        content: Utilities.base64Encode(deptGuide.getBlob().getBytes())
      });
    }
    
  } catch (error) {
    console.error('添付ファイル準備エラー:', error);
  }
  
  return attachments;
}
```

**【セリフ】**: 「単純なメール送信ではなく、添付ファイル付きの本格的なメール配信ができました」

---

## ⚡ 実装デモ Part2: Calendar API統合（4:30-6:00）

### **セリフ**
「次に、Calendar APIで複数のカレンダーに自動予定登録します」

#### **Step 1**: Calendar API設定（4:30-4:45）
**【操作】**:
1. Apps Script → サービス → Calendar API追加
2. 「Calendar API が利用可能になりました」

#### **Step 2**: 複数イベント自動作成（4:45-6:00）
**【コード実演】**:
```javascript
function createMultipleCalendarEvents(employeeData) {
  console.log('Calendar API実行:', employeeData.name);
  
  const events = generateCalendarEvents(employeeData);
  const createdEvents = [];
  
  events.forEach(eventData => {
    try {
      const event = Calendar.Events.insert(eventData.event, eventData.calendarId);
      createdEvents.push({
        eventId: event.id,
        summary: event.summary,
        calendarId: eventData.calendarId
      });
      console.log(`イベント作成成功: ${event.summary}`);
    } catch (eventError) {
      console.error(`イベント作成失敗: ${eventData.event.summary}`, eventError);
    }
  });
  
  return { 
    success: true, 
    createdEvents: createdEvents, 
    count: createdEvents.length 
  };
}

function generateCalendarEvents(employeeData) {
  const startDate = new Date(employeeData.startDate);
  const events = [];
  
  // 1. ウェルカム面談（人事カレンダー）
  events.push({
    calendarId: 'primary',
    event: {
      summary: `【ウェルカム面談】${employeeData.name}様`,
      start: { dateTime: new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate(), 10, 0).toISOString() },
      end: { dateTime: new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate(), 11, 0).toISOString() },
      attendees: [
        { email: employeeData.email },
        { email: 'hr@company.com' },
        { email: getDepartmentManager(employeeData.department).email }
      ],
      conferenceData: {
        createRequest: { requestId: `welcome-${employeeData.name}-${Date.now()}` }
      }
    }
  });
  
  // 2. 部署オリエンテーション（部署カレンダー）
  events.push({
    calendarId: getDepartmentCalendarId(employeeData.department),
    event: {
      summary: `${employeeData.department} オリエンテーション - ${employeeData.name}様`,
      start: { dateTime: new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate(), 14, 0).toISOString() },
      end: { dateTime: new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate(), 15, 30).toISOString() },
      attendees: getDepartmentMembers(employeeData.department)
    }
  });
  
  // 3. 1週間後フォローアップ
  const followUpDate = new Date(startDate);
  followUpDate.setDate(followUpDate.getDate() + 7);
  
  events.push({
    calendarId: 'primary',
    event: {
      summary: `【1週間フォローアップ】${employeeData.name}様`,
      start: { dateTime: new Date(followUpDate.getFullYear(), followUpDate.getMonth(), followUpDate.getDate(), 16, 0).toISOString() },
      end: { dateTime: new Date(followUpDate.getFullYear(), followUpDate.getMonth(), followUpDate.getDate(), 16, 30).toISOString() },
      attendees: [
        { email: employeeData.email },
        { email: getDepartmentManager(employeeData.department).email }
      ]
    }
  });
  
  return events;
}
```

**【セリフ】**: 「一度の実行で、3つの重要な予定が自動的に関係者のカレンダーに登録されました」

---

## 💬 実装デモ Part3: Chat API統合（6:00-7:30）

### **セリフ**
「最後に、Google Chat APIで部署別通知を自動送信します」

#### **Step 1**: Chat Webhook設定（6:00-6:15）
**【操作・セリフ】**:
1. Google Chat → Webhookの設定
2. 部署ごとのWebhook URL取得
3. Apps Script のプロパティに保存

#### **Step 2**: リッチカード通知送信（6:15-7:30）
**【コード実演】**:
```javascript
function sendDepartmentChatNotifications(employeeData) {
  console.log('Chat API実行');
  
  const notifications = [
    {
      department: 'IT部門',
      webhook: PropertiesService.getScriptProperties().getProperty('IT_CHAT_WEBHOOK'),
      message: createITDepartmentMessage(employeeData)
    },
    {
      department: '総務部',
      webhook: PropertiesService.getScriptProperties().getProperty('GA_CHAT_WEBHOOK'),
      message: createGADepartmentMessage(employeeData)
    }
  ];
  
  const results = [];
  
  notifications.forEach(notification => {
    if (notification.webhook) {
      const result = sendRichChatMessage(notification.webhook, notification.message);
      results.push({
        department: notification.department,
        success: result.success
      });
    }
  });
  
  return results;
}

function createITDepartmentMessage(employeeData) {
  return {
    text: `🆕 新入社員PC準備のお願い`,
    cards: [{
      header: {
        title: `IT部門への新入社員準備依頼`,
        subtitle: `${employeeData.name}様（${employeeData.position}）`,
        imageUrl: 'https://developers.google.com/chat/images/quickstart-app-avatar.png'
      },
      sections: [{
        widgets: [{
          textParagraph: {
            text: `<b>新入社員情報:</b><br>
👤 氏名: ${employeeData.name}<br>
📅 入社日: ${employeeData.startDate}<br>
🏢 部署: ${employeeData.department}<br>
💼 職種: ${employeeData.position}<br>
📧 メール: ${employeeData.email}`
          }
        }]
      }, {
        header: `📋 IT部門担当タスク`,
        widgets: [{
          textParagraph: {
            text: `• <b>PC・周辺機器の準備</b><br>
• <b>メールアカウント・システム権限設定</b><br>
• <b>VPN・セキュリティ設定</b><br>
• <b>開発環境構築（${employeeData.department}用）</b>`
          }
        }]
      }, {
        widgets: [{
          buttons: [{
            textButton: {
              text: 'タスク管理シートを開く',
              onClick: {
                openLink: {
                  url: getTaskSheetUrl()
                }
              }
            }
          }]
        }]
      }]
    }]
  };
}

function sendRichChatMessage(webhookUrl, message) {
  try {
    const options = {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      payload: JSON.stringify(message)
    };
    
    const response = UrlFetchApp.fetch(webhookUrl, options);
    
    return { 
      success: response.getResponseCode() === 200,
      response: response.getContentText() 
    };
    
  } catch (error) {
    console.error('Chat送信エラー:', error);
    return { success: false, error: error.message };
  }
}
```

**【セリフ】**: 「見た目も美しく、必要な情報とアクションボタンも含んだリッチな通知が送信されました」

---

## 🎯 統合実行デモ（7:30-8:45）

### **セリフ**
「では、完成した統合システムを実際にテストしてみましょう！」

#### **統合実行関数**
**【コード・実演】**:
```javascript
function executeIntegratedAutomation(employeeData) {
  console.log('=== 統合自動化実行開始 ===');
  
  try {
    // 並行処理で全API実行
    const results = {
      email: sendWelcomeEmailWithAttachments(employeeData),
      calendar: createMultipleCalendarEvents(employeeData),
      chat: sendDepartmentChatNotifications(employeeData),
      files: createEmployeeFolder(employeeData)
    };
    
    // 実行結果をログ
    logIntegrationResults(employeeData, results);
    
    console.log('=== 統合自動化完了 ===');
    return results;
    
  } catch (error) {
    console.error('統合処理エラー:', error);
    return { success: false, error: error.message };
  }
}
```

#### **実演結果**
**【セリフ・画面】**:
1. **メール送信**: 「添付ファイル付きの歓迎メールが送信されました」
2. **カレンダー**: 「3つの予定が関係者のカレンダーに自動登録」
3. **Chat通知**: 「IT部門と総務部に美しいカード通知が配信」
4. **ファイル**: 「個人フォルダと必要書類が自動作成」

**【セリフ】**: 「わずか10秒で、従来なら1時間かかっていた全ての作業が完了しました！」

---

## 📊 実行結果の可視化（8:45-9:15）

### **セリフ**
「統合システムでは、全ての処理結果を一元管理することも重要です」

**【画面】**: 実行ログ表示
```javascript
function logIntegrationResults(employeeData, results) {
  const logSheet = getOrCreateIntegrationLogSheet();
  
  logSheet.appendRow([
    new Date(),
    employeeData.name,
    employeeData.email,
    results.email.success ? '成功' : '失敗',
    results.calendar.count || 0,
    results.chat.filter(r => r.success).length,
    results.files.success ? '成功' : '失敗',
    JSON.stringify(results)
  ]);
}
```

**【セリフ】**: 「どの処理が成功し、どこで問題があったかが一目瞭然。継続的な改善に活用できます」

---

## 🎯 まとめ・次回予告（9:15-10:00）

### **セリフ**
「今日学んだこと」
- Gmail API による高度なメール配信
- Calendar API による複数予定自動登録
- Chat API によるリッチ通知配信
- 統合実行による真の自動化

**【実現できたこと】**:
- 一つのトリガーで全自動化
- 並行処理による高速実行
- エラー耐性の高いシステム
- 実行結果の可視化

**【次回予告】**:
「次回は、この統合システムをさらに発展させて、タスク管理と部署別リマインド通知システムを構築します。スプレッドシートベースのタスク管理とGoogle Chatの高度な活用をお見せします！」

---

## 🎥 撮影メモ

### **画面構成**
- **メイン**: Apps Script エディタ
- **サブ**: 各Google サービス（Gmail、Calendar、Chat）
- **結果確認**: 複数タブで同時確認

### **デモのポイント**
1. **API設定**: 各サービスの有効化手順
2. **統合コーディング**: 複数API の協調動作
3. **並行実行**: 高速処理の実現
4. **結果確認**: 各サービスでの動作確認

### **強調ポイント**
- 統合の威力
- Google環境の一貫性
- 拡張性の高さ
- 運用の容易さ

この実装により、真の統合自動化システムが完成し、次のステップへの基盤が整います。