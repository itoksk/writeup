# Google Workspace Studio 拡張開発講座 - カスタムステップ作成マスター

## コース概要
Google Workspace Studioの標準ステップでは実現できない処理を、Apps Scriptでカスタムステップとして開発する方法を学ぶ開発者向け講座です。5つのレッスンで、基礎から実践的なCRM連携ステップの作成、本番デプロイまでをカバーします。

## 対象者
- Apps Script の基礎知識がある開発者
- Workspace Studio の標準ステップでは要件を満たせない方
- 社内向けカスタムステップを開発したい方
- 外部API連携やCRM連携を自動化したい方

## 前提知識
- JavaScript / Apps Script の基本的な理解
- Google Workspace Studio の基本操作（エージェント作成経験）
- JSON の読み書きができること

## カリキュラム（全5回）

### 第1回：カスタムステップ入門 - 計算機ステップを作ってみよう
**概念理解とクイックスタート**

- **学習目標**: カスタムステップの仕組みを理解し、最初のステップを作成・テストする
- **内容**:
  - Workspace Studio の拡張アーキテクチャ
  - エージェント・ステップ・スターターの関係
  - 入力変数・出力変数・動的変数の概念
  - マニフェストファイル（appsscript.json）の構造
  - 計算機ステップのクイックスタート
  - テストデプロイとエージェントでの動作確認

- **作成するもの**: 2つの数値と演算子を受け取り、計算結果を返す計算機ステップ

- **主要コード**:
  - `appsscript.json`: マニフェスト定義
  - `onConfigFunction()`: 構成カードUI
  - `onExecuteFunction()`: ステップ実行ロジック

### 第2回：入出力変数を極める - データの受け渡しをマスター
**入力収集と出力返却の実装**

- **学習目標**: 入力変数で柔軟にデータを収集し、出力変数で後続ステップにデータを渡す
- **内容**:
  - マニフェストでの入力変数定義（inputs[]配列）
  - データ型: STRING, INTEGER, TIMESTAMP, BOOLEAN, EMAIL_ADDRESS
  - カーディナリティ: SINGLE（単一値）
  - 構成カードでの入力ウィジェット作成
  - TextInput, SelectionInput, DateTimePicker の使い方
  - hostAppDataSource で前のステップの出力を参照
  - マニフェストでの出力変数定義（outputs[]配列）
  - onExecuteFunction での出力変数返却
  - AddOnsResponseService の使い方

- **作成するもの**: メール情報を収集し、解析結果を複数の出力変数で返すステップ

### 第3回：入力検証でエラーを防ぐ - バリデーションの実装
**クライアントサイド・サーバーサイド検証**

- **学習目標**: ユーザー入力を検証し、エラーを未然に防ぐ
- **内容**:
  - なぜ入力検証が重要か
  - クライアントサイド検証
    - Validation クラスによる基本検証（文字数制限など）
    - CEL（Common Expression Language）検証
    - 条件に応じたウィジェットの表示/非表示
  - サーバーサイド検証
    - onSaveFunction() の実装
    - 検証エラー時のカード再表示
    - エラーメッセージの表示方法
  - 検証エラーのハンドリング

- **作成するもの**: メールアドレス形式を検証し、不正な場合はエラー表示するステップ

### 第4回：実践 - CRM連携カスタムステップを作る
**外部API連携とカスタムリソース**

- **学習目標**: 実務で使えるCRM連携ステップを作成する
- **内容**:
  - カスタムリソースの概念と定義
  - workflowResourceDefinitions の設定
  - 複数フィールドを持つカスタムリソースの作成
  - カスタムリソースを参照として出力（パフォーマンス最適化）
  - providerFunction の実装
  - 外部API（REST API）への接続
  - UrlFetchApp によるHTTPリクエスト
  - 認証情報の安全な管理
  - エラーハンドリングとリトライ

- **作成するもの**:
  - リード情報を外部CRMに登録するステップ
  - CRMからリード情報を取得するステップ

### 第5回：デプロイと運用 - 本番公開への道
**バージョン管理・ログ・公開**

- **学習目標**: 本番環境へのデプロイと継続的な運用方法を理解する
- **内容**:
  - バージョン管理
    - current_version と min_version の設定
    - 後方互換性の維持
    - バージョンごとの動作分岐
  - アクティビティログ
    - ログのカスタマイズ
    - デバッグとトラブルシューティング
  - 動的変数の活用
    - 動的な入出力の定義
    - dynamicResourceDefinitionProvider
  - テストデプロイから本番デプロイへ
  - アドオンの公開プロセス
  - 運用のベストプラクティス

- **作成するもの**: 複数バージョンをサポートするステップ、詳細なログを出力するステップ

## 技術スタック
- Google Apps Script
- Google Workspace Add-ons API
- AddOnsResponseService
- CardService
- UrlFetchApp（外部API連携）

## 主要な関数・クラス

### マニフェスト構造
```json
{
  "addOns": {
    "common": { "name": "...", "logoUrl": "..." },
    "flows": {
      "workflowElements": [
        {
          "id": "stepId",
          "state": "ACTIVE",
          "name": "Step Name",
          "workflowAction": {
            "inputs": [...],
            "outputs": [...],
            "onConfigFunction": "...",
            "onExecuteFunction": "...",
            "onSaveFunction": "..."
          }
        }
      ],
      "workflowResourceDefinitions": [...]
    }
  }
}
```

### 主要関数
| 関数 | 役割 |
|------|------|
| onConfigFunction() | 構成カードUIを返す |
| onExecuteFunction() | ステップ実行時の処理 |
| onSaveFunction() | サーバーサイド検証 |
| providerFunction() | カスタムリソースのデータ取得 |

### AddOnsResponseService
| メソッド | 用途 |
|----------|------|
| newVariableData() | 出力変数データの作成 |
| newReturnOutputVariablesAction() | 出力変数を返すアクション |
| newHostAppAction() | ホストアプリへのアクション |
| newRenderActionBuilder() | レスポンスのビルド |
| newSaveWorkflowAction() | ステップの保存 |
| newWorkflowValidationErrorAction() | 検証エラーの返却 |

## 達成できること
- 標準ステップにない独自機能の追加
- 外部SaaS（CRM、SFA、ERP等）との連携
- 複雑なビジネスロジックの実装
- 社内システムとの統合
- 他の開発者・組織へのステップ提供

## 注意事項
- カスタムステップはApps Scriptの知識が必須です
- 可能な限り標準ステップを優先してください（ノーコードの利点を活かす）
- 外部API連携時は認証情報の管理に注意してください
- 本番デプロイ前に十分なテストを行ってください

## 必要条件
- Google Workspace アカウント（Workspace Studio へのアクセス権）
- Apps Script エディタへのアクセス
- （第4回）外部API のエンドポイントとAPIキー

## 参考ドキュメント
- [Google Workspace Studio を拡張する](https://developers.google.com/workspace/add-ons/studio?hl=ja)
- [ステップを作成する](https://developers.google.com/workspace/add-ons/studio/build-a-step?hl=ja)
- [入力変数を使用してデータを収集する](https://developers.google.com/workspace/add-ons/studio/input-variables?hl=ja)
- [クイックスタート: 計算機ステップを作成する](https://developers.google.com/workspace/add-ons/studio/quickstart-calculator?hl=ja)
