# 動画3: PDFの内容をAIに"読ませる" - Vision APIで全ての文字をテキスト化する

## 📝 セリフと流れ（10分構成）

### 🎬 オープニング（0:00-1:00）
**セリフ**:
「人間の目が画像を『風景』や『文字』と認識するように、AIにも"目"があります。今回は、前回有効化したGoogleのAIの"目"、Vision APIを使って、これまでただの画像の塊だったPDFに魔法をかけます。

あなたの手で書いたコードが、AIを動かし、文字を認識する…プログラミングの醍醐味とAIの凄さを、ここで体感してください！

この10分で、PDFファイルから完璧なテキストデータを抽出する、OCR機能の実装を完了させます。」

**画面表示**: Vision API の概要図とOCR処理のBefore/After

---

### 👁️ Vision APIの仕組み解説（1:00-2:30）
**セリフ**:
「まず、Vision APIがどのように文字を認識するのか、簡単に説明します。

Vision APIは、Googleの膨大な画像データで訓練されたAIです。手書き文字、印刷文字、さらには複雑なレイアウトの文書まで、人間以上の精度で文字を認識できます。

今回使用するのは『TEXT_DETECTION』機能。これは、画像内のすべての文字を検出し、テキストデータとして抽出する機能です。

処理の流れは、たったの4ステップ。
1. PDFファイルを取得
2. Base64形式に変換 
3. Vision APIに送信
4. テキスト結果を受信

シンプルですが、この裏側では最先端のAI技術が動いています。」

**画面表示**: 
- Vision APIの仕組み図解
- 4ステップの処理フロー
- OCR精度のデモ画像

---

### 💻 実装コードの解説（2:30-5:00）
**セリフ**:
「それでは、実際のコードを見ながら実装していきましょう。

今回の動画3では、2つのモードを用意しています。

**テストモード**と**本格運用モード**です。

まず、学習用の`テストモード`から始めます。これは、Vision APIの課金設定をしなくても、OCR処理の流れを体験できるモードです。

メイン処理関数は`processLatestPDF`。この関数が、フォルダ内のPDFファイルを自動で見つけて、OCR処理を実行します。

重要なのは、必ずtry-catchでエラーハンドリングを行うこと。APIは外部サービスなので、ネットワークの問題やファイルの問題が発生する可能性があります。

OCR処理の核心部分は、`processNewPDFAdvanced`関数です。この関数は、テストモードと本格運用モードを自動で判別し、適切な処理を行います。

本格運用時は、PDFを画像に変換してからVision APIに送信。テストモード時は、あらかじめ用意したサンプルテキストを返します。

今日は、まずテストモードで動作を確認し、次回以降で本格運用に移行していきます。」

**画面表示**: 
- Apps Scriptエディタでのコード入力
- テストモード/本格運用モードの違い説明
- 重要な部分のハイライト

---

### 🧪 実際のテスト実行（5:00-7:30）
**セリフ**:
「コードが書けたら、実際にテストしてみましょう。

今回は、Vision APIの課金設定をしなくても体験できる『テストモード』から始めます。

まず、テストモードを有効化します。Apps Scriptで`enableTestMode`関数を実行してください。これで、実際のVision APIを使わずに、OCR処理の流れを体験できます。

次に、サンプルの注文書PDFを、Google Driveの『AI受注処理』フォルダにアップロードします。ドラッグ&ドロップするだけです。

もし『AI受注処理』フォルダが見つからない場合は、`investigateFolderContents`関数で詳細を調査するか、`createAIProcessingFolder`関数でフォルダを作成してください。

準備ができたら、Apps Scriptで`processLatestPDF`関数を実行します。この関数は、AI受注処理フォルダ内の最新PDFファイルを自動で見つけて処理します。

実行ボタンを押すと…ログを見てください。

『🧪 テストモードで実行中』と表示され、フォルダ内のPDFファイルを検索します。見つかったファイル名が表示され、『⚠️ テストモード：模擬OCR結果を返します』のメッセージと共に、サンプルの抽出テキストが表示されました！

このサンプルテキストには、会社名、商品名、数量、金額など、実際の注文書に含まれる情報がすべて含まれています。

さらに、テキスト解析機能も動作し、会社名候補、金額候補、日付候補が自動で抽出されます。

最後に、PDFファイルは自動的に『処理済み』フォルダに移動されます。

これで、OCR処理の全体的な流れが確認できました。本格運用時は、実際のVision APIが同じ流れでPDFを読み取ることになります。」

**画面表示**: 
- enableTestMode関数の実行
- 実際のPDFアップロード操作（ドラッグ&ドロップ）
- investigateFolderContents関数でのフォルダ調査
- processLatestPDF関数の実行画面
- テストモードでの処理進捗表示
- 模擬OCR結果とテキスト解析結果
- ファイルの自動移動の様子

---

### ⚠️ よくある問題と対策（7:30-8:30）
**セリフ**:
「テストモードでも発生する可能性がある問題と、その解決策をお話しします。

まず、『PDFファイルが見つかりません』エラー。これは最も多い問題です。

解決策は、`investigateFolderContents`関数を実行して詳細を調査することです。フォルダが存在しない場合、ファイルが別の場所にある場合、ファイル形式が違う場合など、具体的な原因が分かります。

フォルダが見つからない場合は、`createAIProcessingFolder`関数でフォルダを作成できます。

次に、『処理済みファイルの重複処理』問題。同じファイルが何度も処理されることがあります。これは、ファイルが『処理済み』フォルダに移動されていない場合に発生します。

また、本格運用時には追加の問題も発生する可能性があります。

『This API method requires billing』エラーは、Vision APIの課金が有効化されていない場合です。`showProductionSetupGuide`関数で詳細な移行手順を確認できます。

『Bad image data』エラーは、PDFの画像変換が失敗した場合です。ファイルの形式やサイズを確認してください。

エラーが発生したら、慌てずにログを確認し、適切な調査関数を使って原因を特定しましょう。」

**画面表示**: 
- investigateFolderContents関数の実行結果
- よくあるエラーメッセージの例
- createAIProcessingFolder関数の実行
- showProductionSetupGuide関数の表示内容

---

### 📊 処理結果の確認と品質評価（8:30-9:30）
**セリフ**:
「抽出されたテキストの品質を確認する方法も重要です。

テストモードで表示されたサンプルテキストを見てください。注文書として必要な情報が、きれいに構造化されて表示されています。

今回実装した`analyzeExtractedText`関数で、自動的な品質チェックが行われます。実行ログを確認すると：

- 総行数：35行
- 総文字数：368文字
- 会社名候補：『株式会社サンプル商事』が検出
- 金額候補：単価、金額、小計、消費税、合計が全て検出
- 日付候補：注文日と納期希望が検出

これらの情報が適切に抽出されていることで、次の動画4のChatGPT処理で高精度な結果が期待できます。

本格運用時は、実際のVision APIが同様の精度でテキストを抽出します。OCRの精度は、入力PDFの品質に大きく依存するため、きれいな文書ほど良い結果が得られます。

重要なのは、この段階ではまだ『テキスト化』までです。スプレッドシートへの記録や通知は、今後の動画で実装していきます。」

**画面表示**: 
- テストモードでの抽出テキスト全文表示
- analyzeExtractedText関数の分析結果
- 検出された会社名、金額、日付の候補一覧
- 動画の進捗表示（現在地：動画3/8）

---

### 🔚 まとめと次回予告（9:30-10:00）
**セリフ**:
「お疲れさまでした！今回で、PDFから『読める』テキストデータへの変換システムが完成しました。

今回達成したこと：
- テストモードでOCR処理の流れを体験
- PDFファイルの自動検出と処理
- テキスト抽出と品質チェック機能
- 処理済みファイルの自動整理
- 本格運用への移行準備

これで、AIが文書の内容を『見る』ことができるようになりました。しかし、まだ『理解』はできていません。

抽出されたテキストは、人間が読めばすぐに理解できますが、コンピューターにとってはただの文字列です。

次回の動画4では、このテキストデータからChatGPTを使って、必要な情報だけを正確に抽出する技術を学びます。

『出力結果を左右する！必要情報を抽出するプロンプト作成術』では、AIから最高の結果を引き出す『魔法の呪文』、プロンプトの設計方法を詳しく解説します。

OCRで『読める』ようになったテキストを、ChatGPTで『理解』させ、動画6ではスプレッドシートに構造化して記録します。

いよいよ、AIの真価を発揮する段階に進みます！」

**画面表示**: 
- 今回の成果まとめ（テキスト化完了）
- 全体システムでの現在位置（動画3完了）
- 次回動画のプレビュー（ChatGPT連携）
- 学習進捗の表示（3/8完了）

---

## 📋 撮影チェックリスト

### 事前準備
- [ ] テストモード用コードの動作確認
- [ ] サンプル注文書PDFの準備
- [ ] investigateFolderContents関数の動作確認
- [ ] enableTestMode/disableTestMode関数の動作確認
- [ ] 本格運用移行手順の確認

### 撮影時の注意点
- [ ] テストモードの説明を丁寧に
- [ ] 段階的な実装アプローチを強調
- [ ] 初心者でも迷わない手順の明示
- [ ] エラー調査機能の使い方を詳細に説明
- [ ] 本格運用との違いを明確に

### 必要な画面録画
- [ ] enableTestMode関数の実行
- [ ] PDFアップロード手順（ドラッグ&ドロップ）
- [ ] investigateFolderContents関数でのフォルダ調査
- [ ] processLatestPDF関数の実行（テストモード）
- [ ] 模擬OCR結果の表示と解析
- [ ] ファイルの自動移動確認
- [ ] showProductionSetupGuide関数の表示
- [ ] checkProductionReadiness関数の実行

### 新機能のデモ
- [ ] フォルダが見つからない場合の対処法
- [ ] createAIProcessingFolder関数でのフォルダ作成
- [ ] テストモード/本格運用モードの切り替え
- [ ] 本格運用への移行準備手順