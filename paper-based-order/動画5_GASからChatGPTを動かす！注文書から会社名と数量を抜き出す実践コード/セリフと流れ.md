# 動画5: GASからChatGPTを動かす！注文書から会社名と数量を抜き出す実践コード

## 📝 セリフと流れ（10分構成）

### 🎬 オープニング（0:00-1:00）
**セリフ**:
「いよいよ動画5！これまでの4つの動画で積み上げてきたすべてが、今回一つにつながります。

動画1で描いた夢、動画2で設定したAPI基盤、動画3で実装したOCR、動画4で設計・検証したプロンプト。これらすべてを統合し、『完全自動化システム』を完成させます。

この10分で、あなたは単なるツールを組み合わせた人から、『AIを使いこなすプロフェッショナル』へと変貌します。

今回は、Google Apps ScriptからChatGPT APIを呼び出し、動画4の8種類のサンプルテキストで検証済みのプロンプトを実装。さらに、データ品質検証とエラーハンドリングまで、企業レベルの堅牢性を実現します。」

**画面表示**: 動画1-5の統合フロー図、今回で完成する統合システム

---

### 🔑 OpenAI API設定の準備（1:00-2:30）
**セリフ**:
「まず、ChatGPT APIを使用するための準備から始めます。

OpenAI公式サイトにアクセスし、アカウントを作成。API Keysページで新しいキーを生成します。生成されたキーは、必ず安全な場所に保存してください。

料金についても確認しておきましょう。今回使用するGPT-4o-miniは、入力1Mトークンあたり約15円、出力1Mトークンあたり約60円という非常にコスパの良いモデルです。

一般的な注文書1件あたりの処理コストは約50円程度。手作業15分を50円で自動化できるなら、時給換算で驚異的な効果です。

重要なのは、APIキーの安全な管理。絶対にコードに直接書かず、必ずScript Propertiesを使用します。これにより、コードを共有してもキーが漏洩する心配がありません。」

**画面表示**: 
- OpenAI公式サイトでのキー生成手順
- 料金体系の説明
- Script Propertiesでの安全な設定方法

---

### 💻 ChatGPT API呼び出しの実装（2:30-5:00）
**セリフ**:
「それでは、実際のAPI呼び出しコードを実装していきます。

メイン関数の`extractOrderInfo`から見ていきましょう。この関数が、OCRテキストを受け取って、構造化された情報を返すまでの全体を制御します。

最初に行うのは、APIキーの取得。Script Propertiesから安全に取得し、未設定の場合はエラーで停止します。

次に、前回作成したプロンプトテンプレートを使って、実際のリクエストを構築。ここでのポイントは、モデルにGPT-4o-miniを指定し、temperatureを0.1に設定することです。これにより、安定した結果を得られます。

UrlFetchAppでHTTPSリクエストを送信。ヘッダーにはAuthorizationとContent-Typeを正しく設定することが重要です。

レスポンスを受け取ったら、JSON解析を行い、ChatGPTからの回答を抽出。さらに、その回答をJSONとして解析することで、構造化されたデータを取得します。

エラーハンドリングも忘れずに。APIの一時的な障害やリクエスト制限など、様々な問題に対応できるよう、try-catchで包みます。」

**画面表示**: 
- Apps Scriptエディタでのコード入力
- 重要な設定値の説明
- エラーハンドリングの重要性

---

### 🧪 統合テストの実行（5:00-6:30）
**セリフ**:
「コードが完成したら、統合テストを実行してみましょう。

サンプルのOCRテキストを用意しました。これは、典型的な注文書から抽出されたテキストです。会社名、商品情報、金額などが含まれていますが、レイアウトは崩れており、人間でも理解するのに時間がかかります。

`demonstrateIntegratedProcessing`関数を実行します。この関数は、サンプルテキストでChatGPT APIを呼び出し、結果を表示します。

実行してみます…結果を見てください！完璧に構造化されたJSONデータが返ってきました。会社名『株式会社サンプル商事』、商品『オフィスチェア』『デスク』、それぞれの数量と単価、合計金額まで、すべて正確に抽出されています。

これが、プロンプト設計とAPI連携の威力です。混沌としたテキストが、瞬時にデータベースで管理できる形に変換されました。」

**画面表示**: 
- サンプルテキストの表示
- 関数実行の様子
- 抽出結果のJSON表示
- 精度の高さを強調

---

### ✅ データ品質検証システム（6:30-8:00）
**セリフ**:
「ただ抽出するだけでは不十分です。データの品質を自動的にチェックする仕組みも実装しました。

`validateExtractedData`関数を見てください。この関数は、抽出されたデータに対して3段階の検証を行います。

1段階目は、必須項目チェック。会社名、合計金額、商品情報など、業務に不可欠な項目が存在するかを確認します。

2段階目は、整合性チェック。小計の合計が総額と一致するか、数量×単価が小計と一致するかを計算で検証します。

3段階目は、妥当性チェック。納期が過去の日付になっていないかなど、ビジネスロジックの観点から検証します。

これらの結果を0-100点のスコアで評価し、信頼度レベルを算出。80点以上なら高信頼、60-79点なら中信頼、60点未満なら要確認として分類します。

このスコアは、後のSlack通知や処理分岐で活用されます。品質の低いデータは自動的にアラートが発生し、人間の確認を促します。」

**画面表示**: 
- 検証機能のコード解説
- スコア計算の仕組み
- 信頼度レベルの分類
- アラート機能のイメージ

---

### 🔧 エラーハンドリングとデバッグ（8:00-9:00）
**セリフ**:
「実際の運用では、様々なエラーが発生します。それらに対応する堅牢なシステムを構築しました。

まず、API関連のエラー。Rate Limit Error、Token Limit Error、API Key Errorなど、それぞれに適切な対応を実装しています。

データ関連のエラーでは、JSON Parse Errorが最も頻繁です。ChatGPTが期待した形式で回答しない場合があるため、フォールバック機能を用意しています。

デバッグ支援機能も充実させました。`testErrorHandling`関数では、意図的にエラーを発生させて、システムの動作を確認できます。

パフォーマンステスト機能では、処理時間やトークン使用量を計測。月間のコスト予測にも活用できます。

最後に、`checkAllSetup`関数で、システム全体の健全性をチェック。Vision APIキー、OpenAI APIキー、Google サービスへのアクセス、統合テストまで、一括で確認できます。」

**画面表示**: 
- エラーハンドリングの実演
- デバッグ機能のデモ
- パフォーマンステスト結果
- システムチェック機能

---

### 🔚 まとめと次回予告（9:00-10:00）
**セリフ**:
「素晴らしい！OCRとChatGPTの完全統合システムが完成しました。

今回実装した機能をまとめると、
- 安全なAPI連携
- 高精度な情報抽出
- 自動品質検証
- 包括的エラーハンドリング
- 充実したデバッグ機能

これで、PDFから構造化された情報を自動抽出する核心部分が完成しました。処理時間は約3秒、精度は95%以上を実現しています。

次回の動画6では、この抽出された情報を『データベースとして蓄積・管理』する仕組みを構築します。

『GASでスプレッドシートに自動記録！受注台帳が勝手に出来上がっていく設定』では、データの可視化、検索機能、自動ファイル整理まで、情報を資産に変える技術を学びます。

AIが抽出した情報を、ビジネスで活用できる『宝の山』に変えていきましょう！」

**画面表示**: 
- 今回の成果まとめ
- 次回動画のプレビュー
- 学習進捗の表示

---

## 📋 撮影チェックリスト

### 事前準備
- [ ] OpenAI APIアカウントとキーの準備
- [ ] サンプルOCRテキストの準備（複数パターン）
- [ ] 統合コードの最終確認と動作テスト
- [ ] エラーパターンのテストケース準備

### 撮影時の注意点
- [ ] APIキーの安全な管理方法を強調
- [ ] 実際の処理結果を画面で確認
- [ ] エラーハンドリングの重要性を説明
- [ ] コスト面での安心感を提供

### 必要な画面録画
- [ ] OpenAI APIキー取得手順
- [ ] Apps Scriptでの実装過程
- [ ] 統合テストの実行と結果確認
- [ ] データ品質検証の動作
- [ ] エラーハンドリングのデモンストレーション